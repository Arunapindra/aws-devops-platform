name: CI Pipeline

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: aws-devops-platform/app
  DOCKER_BUILDKIT: 1

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-test:
    name: Lint & Validate
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
      - name: Lint Dockerfiles with Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
          format: json
        continue-on-error: true
        id: hadolint
      - name: Post Hadolint results as PR comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2.9.0
        with:
          header: hadolint
          message: |
            ### Dockerfile Lint (Hadolint)
            ```
            ${{ steps.hadolint.outputs.results }}
            ```
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.1
        with:
          terraform_version: 1.7.4
      - name: Terraform Format Check
        id: tf_fmt
        run: terraform fmt -check -recursive -diff terraform/
        continue-on-error: true
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4.0.0
        with:
          tflint_version: v0.50.3
      - name: Run TFLint
        id: tflint
        run: |
          cd terraform
          tflint --init
          tflint --recursive --format compact
        continue-on-error: true
      - name: Terraform Validate (Dev)
        id: tf_validate
        run: |
          cd terraform/environments/dev
          terraform init -backend=false
          terraform validate
        continue-on-error: true
      - name: Post Terraform lint results
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2.9.0
        with:
          header: terraform-lint
          message: |
            ### Terraform Lint Results
            | Check | Status |
            |-------|--------|
            | terraform fmt | ${{ steps.tf_fmt.outcome }} |
            | tflint | ${{ steps.tflint.outcome }} |
            | terraform validate | ${{ steps.tf_validate.outcome }} |
      - name: Setup Helm
        uses: azure/setup-helm@v3.5
        with:
          version: v3.14.2
      - name: Lint Helm charts
        id: helm_lint
        run: |
          for chart in helm-charts/*/; do
            if [ -f "${chart}/Chart.yaml" ]; then
              helm lint "${chart}" --strict
            fi
          done
        continue-on-error: true
      - name: Install yamllint
        run: pip install yamllint==1.35.1
      - name: Run yamllint
        id: yamllint
        run: yamllint -c .yamllint.yaml . || true
        continue-on-error: true
      - name: Check lint results
        if: >
          steps.hadolint.outcome == 'failure' ||
          steps.tf_fmt.outcome == 'failure' ||
          steps.tflint.outcome == 'failure' ||
          steps.tf_validate.outcome == 'failure' ||
          steps.helm_lint.outcome == 'failure'
        run: exit 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.18.0
        with:
          scan-type: fs
          scan-ref: .
          format: table
          exit-code: 0
          severity: CRITICAL,HIGH
          output: trivy-fs-results.txt
      - name: Run Trivy config scan
        uses: aquasecurity/trivy-action@0.18.0
        with:
          scan-type: config
          scan-ref: terraform/
          format: table
          exit-code: 0
          severity: CRITICAL,HIGH
          output: trivy-config-results.txt
      - name: Run Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@v12.2691.0
        with:
          directory: terraform/
          framework: terraform
          output_format: cli
          soft_fail: true
          download_external_modules: true
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2.3.2
        id: gitleaks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: Post security results
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2.9.0
        with:
          header: security-scan
          message: |
            ### Security Scan Results
            | Scanner | Target | Status |
            |---------|--------|--------|
            | Trivy FS | Codebase | Completed |
            | Trivy Config | Terraform | Completed |
            | Checkov | IaC | ${{ steps.checkov.outcome }} |
            | Gitleaks | Git | ${{ steps.gitleaks.outcome }} |
      - name: Upload Trivy results
        if: always()
        uses: actions/upload-artifact@v4.3.1
        with:
          name: trivy-results
          path: |
            trivy-fs-results.txt
            trivy-config-results.txt
          retention-days: 14
      - name: Fail on secrets
        if: steps.gitleaks.outcome == 'failure'
        run: exit 1

  build:
    name: Build & Push
    runs-on: ubuntu-22.04
    needs: [lint-and-test, security-scan]
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_digest: ${{ steps.build-push.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.1.0
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-ci-${{ github.run_id }}
      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2.0.1
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5.5.1
        with:
          images: ${{ steps.ecr-login.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=ref,event=pr,prefix=pr-
      - name: Build and push Docker image
        id: build-push
        uses: docker/build-push-action@v5.1.0
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.base_ref == 'develop' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
      - name: Scan built image with Trivy
        if: github.base_ref == 'develop'
        uses: aquasecurity/trivy-action@0.18.0
        with:
          image-ref: ${{ steps.ecr-login.outputs.registry }}/${{ env.ECR_REPOSITORY }}:sha-${{ github.sha }}
          format: sarif
          output: trivy-image-results.sarif
          severity: CRITICAL,HIGH
      - name: Upload Trivy SARIF
        if: github.base_ref == 'develop'
        uses: github/codeql-action/upload-sarif@v3.24.6
        with:
          sarif_file: trivy-image-results.sarif
        continue-on-error: true

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
      - name: Set up Python
        uses: actions/setup-python@v5.0.0
        with:
          python-version: '3.11'
          cache: pip
      - name: Cache pip dependencies
        uses: actions/cache@v4.0.1
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      - name: Run unit tests with coverage
        id: tests
        run: |
          python -m pytest tests/ --junitxml=test-results.xml --cov=app --cov-report=xml:coverage.xml --cov-report=term-missing -v 2>&1 | tee test-output.txt
        continue-on-error: true
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4.3.1
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml
          retention-days: 30
      - name: Post test results
        if: github.event_name == 'pull_request' && always()
        uses: marocchino/sticky-pull-request-comment@v2.9.0
        with:
          header: unit-tests
          message: |
            ### Unit Test Results
            **Status:** ${{ steps.tests.outcome }}
      - name: Fail if tests failed
        if: steps.tests.outcome == 'failure'
        run: exit 1
