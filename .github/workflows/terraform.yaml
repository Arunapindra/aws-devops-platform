###############################################################################
# Terraform CI/CD
# On PR: plan and post results as comment
# On merge to main: apply with manual approval for prod
# Uses workspaces for environments, DynamoDB for state locking
###############################################################################
name: Terraform CI/CD

on:
  pull_request:
    branches: [main]
    paths:
      - 'terraform/**'
  push:
    branches: [main]
    paths:
      - 'terraform/**'

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.7.4
  TF_STATE_BUCKET: aws-devops-platform-tfstate
  TF_LOCK_TABLE: aws-devops-platform-tflock

jobs:
  ###########################################################################
  # Job 1: Detect which environments changed
  ###########################################################################
  detect-changes:
    name: Detect Changed Environments
    runs-on: ubuntu-22.04
    outputs:
      environments: ${{ steps.changes.outputs.environments }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0

      - name: Detect changed environments
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- terraform/ \
              | grep -oP 'terraform/environments/\K[^/]+' \
              | sort -u \
              | jq -R -s -c 'split("\n") | map(select(. != ""))')
          else
            CHANGED=$(git diff --name-only HEAD~1...HEAD -- terraform/ \
              | grep -oP 'terraform/environments/\K[^/]+' \
              | sort -u \
              | jq -R -s -c 'split("\n") | map(select(. != ""))')
          fi

          # Default to dev if no specific environment detected or modules changed
          if [ "$CHANGED" = "[]" ] || [ -z "$CHANGED" ]; then
            CHANGED='["dev"]'
          fi
          echo "environments=${CHANGED}" >> $GITHUB_OUTPUT
          echo "Changed environments: ${CHANGED}"

  ###########################################################################
  # Job 2: Terraform Plan (on PRs)
  ###########################################################################
  plan:
    name: "Terraform Plan (${{ matrix.environment }})"
    runs-on: ubuntu-22.04
    needs: detect-changes
    if: github.event_name == 'pull_request'
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect-changes.outputs.environments) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.1
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-tf-plan-${{ github.run_id }}

      - name: Terraform Init
        id: init
        run: |
          cd terraform/environments/${{ matrix.environment }}
          terraform init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ matrix.environment }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform Validate
        id: validate
        run: |
          cd terraform/environments/${{ matrix.environment }}
          terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          cd terraform/environments/${{ matrix.environment }}
          terraform plan -no-color -out=tfplan 2>&1 | tee /tmp/plan-output.txt
        continue-on-error: true

      - name: Post plan as PR comment
        uses: marocchino/sticky-pull-request-comment@v2.9.0
        with:
          header: terraform-plan-${{ matrix.environment }}
          message: |
            ### Terraform Plan: `${{ matrix.environment }}`

            | Step | Status |
            |------|--------|
            | Init | ${{ steps.init.outcome }} |
            | Validate | ${{ steps.validate.outcome }} |
            | Plan | ${{ steps.plan.outcome }} |

            <details>
            <summary>Show Plan Output</summary>

            ```hcl
            Plan output is available in the workflow artifacts.
            ```
            </details>

            *Pusher: @${{ github.actor }}, Action: `${{ github.event_name }}`*

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4.3.1
        with:
          name: tfplan-${{ matrix.environment }}
          path: terraform/environments/${{ matrix.environment }}/tfplan
          retention-days: 7

      - name: Fail if plan failed
        if: steps.plan.outcome == 'failure'
        run: exit 1

  ###########################################################################
  # Job 3: Apply Dev (auto on merge to main)
  ###########################################################################
  apply-dev:
    name: "Apply (Dev)"
    runs-on: ubuntu-22.04
    needs: detect-changes
    if: >
      github.event_name == 'push' &&
      contains(fromJson(needs.detect-changes.outputs.environments), 'dev')
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.1
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          cd terraform/environments/dev
          terraform init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=dev/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform Apply
        run: |
          cd terraform/environments/dev
          terraform apply -auto-approve

  ###########################################################################
  # Job 4: Apply Staging (after dev, with approval)
  ###########################################################################
  apply-staging:
    name: "Apply (Staging)"
    runs-on: ubuntu-22.04
    needs: [detect-changes, apply-dev]
    if: >
      always() &&
      github.event_name == 'push' &&
      contains(fromJson(needs.detect-changes.outputs.environments), 'staging')
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.1
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init & Apply
        run: |
          cd terraform/environments/staging
          terraform init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=staging/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"
          terraform apply -auto-approve

  ###########################################################################
  # Job 5: Apply Production (manual approval required)
  ###########################################################################
  apply-prod:
    name: "Apply (Production)"
    runs-on: ubuntu-22.04
    needs: [detect-changes, apply-staging]
    if: >
      always() &&
      github.event_name == 'push' &&
      contains(fromJson(needs.detect-changes.outputs.environments), 'prod')
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.1
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init & Apply
        run: |
          cd terraform/environments/prod
          terraform init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"
          terraform apply -auto-approve
